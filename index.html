export default async function handler(req, res) {
  try {
    if (req.method !== "POST") {
      return res.status(405).json({ ok: false, error: "method_not_allowed" });
    }

    const data = req.body || {};
    if (!data.termsAccepted) return res.status(400).json({ ok:false, error:"terms_required" });
    if (!data.signature)     return res.status(400).json({ ok:false, error:"signature_required" });

    // ====== TEXTMEBOT (WhatsApp) ======
    const textmeKey = process.env.TEXTMEBOT_KEY;
    const phones = (process.env.TEXTMEBOT_PHONES || "")
      .split(",").map(s => s.trim()).filter(Boolean);

    if (!textmeKey) return res.status(500).json({ ok:false, error:"missing_TEXTMEBOT_KEY" });
    if (!phones.length) return res.status(500).json({ ok:false, error:"missing_TEXTMEBOT_PHONES" });

    const days = Array.isArray(data.daysAvailable) ? data.daysAvailable.join(", ") : "";
    const waMsg =
`ðŸ§¾ New ACW Job Application
Name: ${data.name || ""}
Position: ${data.position || ""}
Phone: ${data.phone || ""}
Email: ${data.email || ""}
Start: ${data.startDate || ""}
Days: ${days}`;

    for (const phone of phones) {
      const url =
        `https://api.textmebot.com/send.php` +
        `?recipient=${encodeURIComponent(phone)}` +
        `&apikey=${encodeURIComponent(textmeKey)}` +
        `&text=${encodeURIComponent(waMsg)}`;

      const r = await fetch(url);
      const t = await r.text();
      if (!r.ok) throw new Error(`textmebot_http_${r.status}: ${t}`);
      if (String(t).toLowerCase().includes("error")) throw new Error(`textmebot_error: ${t}`);
    }

    // ====== EMAIL (Resend) ======
    const resendKey = process.env.RESEND_API_KEY;
    const fromEmail = process.env.FROM_EMAIL;
    const toEmails = (process.env.TO_EMAILS || "")
      .split(",").map(s => s.trim()).filter(Boolean);

    if (!resendKey) return res.status(500).json({ ok:false, error:"missing_RESEND_API_KEY" });
    if (!fromEmail) return res.status(500).json({ ok:false, error:"missing_FROM_EMAIL" });
    if (!toEmails.length) return res.status(500).json({ ok:false, error:"missing_TO_EMAILS" });

    const fullEmail =
`New Job Application (Allston Car Wash)
Submitted: ${data.submittedAt || ""}

Name: ${data.name || ""}
Email: ${data.email || ""}
Phone: ${data.phone || ""}
Position: ${data.position || ""}

Address: ${data.street || ""}, ${data.city || ""}, ${data.state || ""} ${data.zip || ""}

Eligible to work: ${data.eligible || ""}
Start date: ${data.startDate || ""}
Employment type: ${data.employmentType || ""}
Hours/week: ${data.hoursPerWeek || ""}
Overtime: ${data.overtime || ""}
Days available: ${days}

Driving stick shift: ${data.stick || ""}
Driverâ€™s license: ${data.license || ""}

Employment history:
Company: ${data.company || ""}
Job title: ${data.jobTitle || ""}
Company phone: ${data.companyPhone || ""}
Reference contact allowed: ${data.contactRef || ""}

Notes:
${data.notes || ""}

Signature (base64 png):
${data.signature || ""}`;

    const resendResp = await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${resendKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        from: fromEmail,
        to: toEmails,
        subject: `New Job Application: ${data.name || "Applicant"} (${data.position || "Position"})`,
        text: fullEmail
      })
    });

    if (!resendResp.ok) {
      const txt = await resendResp.text();
      throw new Error("resend_failed: " + txt);
    }

    return res.status(200).json({ ok: true });
  } catch (e) {
    return res.status(500).json({ ok: false, error: String(e.message || e) });
  }
}
